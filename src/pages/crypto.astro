---
import Container from "@/components/Container.astro";
import Layout from "@/layouts/Layout.astro";
import { format } from "date-fns";
import CryptoPriceTracker from "@/components/CryptoPriceTracker";

export const prerender = false;

const last_updated = new Date("2025-08-25");
const portfolioData = {
  totalInvestment: 1460,
  assets: 4,
  dailyBuyAmount: 5,
  holdings: [
    {
      symbol: "BTC",
      name: "Bitcoin",
      amount: 0.01023962,
      avgPrice: 102685,
      allocation: 70,
    },
    {
      symbol: "ETH",
      name: "Ethereum",
      amount: 0.07948071,
      avgPrice: 2686,
      allocation: 13,
    },
    {
      symbol: "BNB",
      name: "BNB",
      amount: 0.23229521,
      avgPrice: 727,
      allocation: 12,
    },
    {
      symbol: "SOL",
      name: "Solana",
      amount: 0.13551047,
      avgPrice: 161,
      allocation: 5,
    },
  ],
};

// Fetch prices on the server
const fetchPrice = async (symbol: string): Promise<number> => {
  try {
    const response = await fetch(`https://cryptoprices.cc/${symbol}/`);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    const priceText = await response.text();
    return parseFloat(priceText.trim());
  } catch (error) {
    console.error(`Error fetching ${symbol} price:`, error);
    return 0;
  }
};

const fetchATH = async (symbol: string): Promise<number | undefined> => {
  try {
    const response = await fetch(`https://cryptoprices.cc/${symbol}/ATH/`);
    if (!response.ok) {
      return undefined;
    }
    const athText = await response.text();
    return parseFloat(athText.trim());
  } catch (error) {
    console.warn(`Failed to fetch ATH for ${symbol}`, error);
    return undefined;
  }
};

// Fetch all prices in parallel
const pricePromises = portfolioData.holdings.map(async (holding) => {
  const [currentPrice, athPrice] = await Promise.all([
    fetchPrice(holding.symbol),
    fetchATH(holding.symbol),
  ]);

  const currentValue = holding.amount * currentPrice;
  const pnl = currentValue - holding.amount * holding.avgPrice;
  const roi = (pnl / (holding.amount * holding.avgPrice)) * 100;

  let potentialCurrentValue: number | undefined = undefined;
  let potentialPnl: number | undefined = undefined;
  let potentialRoi: number | undefined = undefined;

  if (athPrice && athPrice > 0) {
    potentialCurrentValue = holding.amount * athPrice;
    potentialPnl = potentialCurrentValue - holding.amount * holding.avgPrice;
    potentialRoi = (potentialPnl / (holding.amount * holding.avgPrice)) * 100;
  }

  return {
    symbol: holding.symbol,
    currentPrice,
    athPrice,
    potentialCurrentValue,
    potentialPnl,
    potentialRoi,
    currentValue,
    pnl,
    roi,
    loading: false,
    error: null,
  };
});

const priceResults = await Promise.all(pricePromises);
const priceData = Object.fromEntries(
  priceResults.map((result) => [result.symbol, result])
);
---

<Layout
  title="Crypto Portfolio"
  description="A snapshot of my cryptocurrency investments and their distribution."
>
  <Container>
    <h1
      class="text-5xl mb-8 tracking-tight sm:text-6xl flex font-heading font-bold"
    >
      My crypto portfolio
    </h1>
    <section class="prose max-w-none prose-invert mb-8 prose-a:text-yellow-500">
      <p class="leading-relaxed">
        This page provides a transparent overview of my cryptocurrency
        investment journey. I employ an automated daily investment strategy,
        focusing on a
        <b class="text-yellow-400">long-term, 10-year outlook</b>. Read more
        about the thinking behind this approach in
        <a
          href="/blog/why-i-dca-crypto-now"
          class="text-yellow-400 underline hover:text-yellow-300"
          >Why I DCA crypto now</a
        >. This approach commenced at the beginning of 2025, reflecting a
        commitment to disciplined and patient wealth accumulation in the digital
        asset space.
      </p>
      <p class="leading-relaxed italic">
        "If you aren't thinking about owning a stock for 10 years, don't even
        think about owning it for 10 minutes." â€” Warren Buffett
      </p>
      <p class="text-sm text-zinc-400 mt-4">
        Last updated: {format(last_updated, "MMMM d, yyyy")}
      </p>
    </section>
    <!-- Dynamic Crypto Holdings with Real-time Data -->
    <CryptoPriceTracker
      client:load
      portfolioData={portfolioData}
      priceData={priceData}
    />
  </Container>
</Layout>
